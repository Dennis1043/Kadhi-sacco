<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KADHI SACCO - Admin Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

<style>
body { margin:0; font-family:'Roboto',sans-serif; background:#f0f2f5; }
header { background:#b80000; color:white; padding:20px; font-size:1.5rem; text-align:center; }
main { padding:20px; }

.cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:30px; }
.card-summary { background:white; border-radius:12px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1); text-align:center; }
.card-summary h2 { margin:0; font-size:2rem; color:#b80000; }
.card-summary p { margin:5px 0 0; font-weight:700; color:#555; }

#membersTable { width:100%; border-collapse:collapse; background:white; border-radius:12px; overflow:hidden; }
#membersTable th, #membersTable td { border:1px solid #ddd; padding:10px; text-align:left; font-size:0.9rem; }
#membersTable th { background:#f7f7f7; font-weight:700; }
.expandable-row { display:none; background:#f9f9f9; }
.status { font-weight:700; text-transform:capitalize; }
.status.pending { color:orange; }
.status.approved { color:green; }
.status.rejected { color:red; }
.toggle-btn { cursor:pointer; }

/* Download dropdown styles */
.download-container { margin:20px 0; position:relative; width:250px; }
.download-btn { background:#004d40; color:white; padding:12px; border:none; border-radius:8px; font-size:1rem; width:100%; cursor:pointer; }
.download-options { display:none; position:absolute; bottom:110%; left:0; right:0; background:white; border:1px solid #ddd; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.download-options a { display:block; padding:12px; text-decoration:none; color:#333; }
.download-options a:hover { background:#f5f5f5; }
</style>
</head>

<body>
<header>Admin Dashboard</header>

<main>
  <!-- Placecards -->
  <div class="cards">
    <div class="card-summary" id="totalMembersCard"><h2>0</h2><p>Total Members</p></div>
    <div class="card-summary" id="totalContributionsCard"><h2>0</h2><p>Total Contributions</p></div>
    <div class="card-summary" id="totalLoansCard"><h2>0</h2><p>Total Loans</p></div>
    <div class="card-summary" id="totalFinesCard"><h2>0</h2><p>Total Fines</p></div>
  </div>

  <!-- Download All Data -->
  <div class="download-container">
    <button class="download-btn" onclick="toggleAdminDownload()">⬇️ Download All Data</button>
    <div class="download-options" id="adminDownloadOptions">
      <a href="#" onclick="downloadAdminFile('csv')">Download CSV</a>
      <a href="#" onclick="downloadAdminFile('excel')">Download Excel</a>
      <a href="#" onclick="downloadAdminFile('pdf')">Download PDF</a>
    </div>
  </div>

  <!-- Members Table -->
  <table id="membersTable">
    <thead>
      <tr>
        <th></th>
        <th>Name</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Total Contributions</th>
        <th>Total Loans</th>
        <th>Total Fines</th>
      </tr>
    </thead>
    <tbody id="membersBody"></tbody>
  </table>
</main>

<script>
const BACKEND_URL = "http://127.0.0.1:5000";

async function loadMembersDashboard() {
  const membersBody = document.getElementById('membersBody');

  try {
    const res = await fetch(`${BACKEND_URL}/admin/members/all`);
    const data = await res.json();
    membersBody.innerHTML = '';

    let totalMembers = data.members.length;
    let totalContributions = 0;
    let totalLoans = 0;
    let totalFines = 0;

    data.members.forEach((member, index) => {
      totalContributions += Number(member.totalContribution) || 0;
      totalLoans += Number(member.totalLoan) || 0;
      totalFines += Number(member.totalFines) || 0;

      // Member main row
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="toggle-btn" data-index="${index}">+</td>
        <td>${member.name}</td>
        <td>${member.email}</td>
        <td>${member.phone}</td>
        <td>KES ${Number(member.totalContribution).toLocaleString()}</td>
        <td>KES ${Number(member.totalLoan).toLocaleString()}</td>
        <td>KES ${Number(member.totalFines).toLocaleString()}</td>
      `;
      membersBody.appendChild(row);

      // Expandable row
      const expandRow = document.createElement('tr');
      expandRow.className = 'expandable-row';
      expandRow.innerHTML = `
        <td colspan="7">
          <h4>Contributions</h4>
          <table>
            <tr><th>Amount</th><th>Purpose</th><th>Mpesa Code</th><th>Date</th></tr>
            ${(member.contributions || []).map(c => `<tr>
              <td>KES ${Number(c.amount).toLocaleString()}</td>
              <td>${c.purpose || ''}</td>
              <td>${c.mpesa_code || ''}</td>
              <td>${new Date(c.timestamp).toLocaleDateString()}</td>
            </tr>`).join('')}
          </table>

          <h4>Loans</h4>
          <table>
            <tr><th>Amount</th><th>Purpose</th><th>Months</th><th>Status</th><th>Date</th></tr>
            ${(member.loans || []).map(l => `<tr>
              <td>KES ${Number(l.amount).toLocaleString()}</td>
              <td>${l.purpose || ''}</td>
              <td>${l.months || ''}</td>
              <td class="status ${l.status}">${l.status}</td>
              <td>${new Date(l.timestamp).toLocaleDateString()}</td>
            </tr>`).join('')}
          </table>

          <h4>Fines</h4>
          <table>
            <tr><th>Amount</th><th>Reason</th><th>Status</th><th>Date</th></tr>
            ${(member.fines || []).map(f => `<tr>
              <td>KES ${Number(f.amount).toLocaleString()}</td>
              <td>${f.reason || ''}</td>
              <td class="status ${f.status}">${f.status}</td>
              <td>${new Date(f.issued_on || f.timestamp).toLocaleDateString()}</td>
            </tr>`).join('')}
          </table>
        </td>
      `;
      membersBody.appendChild(expandRow);

      // Toggle expandable row
      row.querySelector('.toggle-btn').addEventListener('click', () => {
        expandRow.style.display = expandRow.style.display === 'table-row' ? 'none' : 'table-row';
        row.querySelector('.toggle-btn').textContent = expandRow.style.display === 'table-row' ? '-' : '+';
      });
    });

    document.getElementById('totalMembersCard').querySelector('h2').textContent = totalMembers;
    document.getElementById('totalContributionsCard').querySelector('h2').textContent = totalContributions.toLocaleString();
    document.getElementById('totalLoansCard').querySelector('h2').textContent = totalLoans.toLocaleString();
    document.getElementById('totalFinesCard').querySelector('h2').textContent = totalFines.toLocaleString();

  } catch (err) {
    membersBody.innerHTML = '<tr><td colspan="7">Error loading members</td></tr>';
    console.error(err);
  }
}

loadMembersDashboard();

// Download dropdown functions
function toggleAdminDownload() {
  const menu = document.getElementById("adminDownloadOptions");
  menu.style.display = menu.style.display === "block" ? "none" : "block";
}

function downloadAdminFile(type) {
  const now = new Date();
  const dateStr = now.toISOString().slice(0,19).replace(/[:T]/g,'_');
  const filename = `KADHI_SACCO_Admin_Summary_as_at_${dateStr}.${type}`;
  window.location.href = `${BACKEND_URL}/download_all/${type}`;
  document.getElementById("adminDownloadOptions").style.display = "none";
}
</script>

</body>
</html>
